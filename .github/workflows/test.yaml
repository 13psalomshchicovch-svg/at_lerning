name: Test

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    # Важно: даём права на запись в репозиторий (для gh-pages)
    permissions:
      contents: write

    steps:
      # 1. Выкачиваем код (самая свежая версия)
      - name: Checkout code
        uses: actions/checkout@v5

      # 2. Устанавливаем Java
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3. Запускаем Selenoid
      - name: Start Selenoid
        uses: Xotabu4/selenoid-github-action@v2
        # Если не стартует — попробуй явно указать параметры (пример ниже)
        # with:
         version: '1.10.7'           # или последняя стабильная
        args: '-limit 10 -tmpfs 128'

      # 4. Запускаем тесты (selenide.remote уже должен работать)
      - name: Run Gradle tests
        run: ./gradlew clean test -Dselenide.remote=http://localhost:4444/wd/hub

      # 5. Скачиваем историю (только если предыдущие шаги прошли или always)
      - name: Checkout gh-pages (for Allure history)
        if: always()
        uses: actions/checkout@v5
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      # 6. Генерируем Allure отчёт
      - name: Generate Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        with:
          gh_pages: gh-pages
          allure_results: build/allure-results
          allure_report: allure-report
          allure_history: allure-history

      # 7. Публикуем отчёт в gh-pages
      - name: Deploy Allure report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4   # обновили до v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
          # force_orphan: true   # раскомментировать, если нужно чистую историю
